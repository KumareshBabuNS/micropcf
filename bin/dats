#!/bin/bash

set -e

if [[ -z $1 ]] || [[ -z $2 ]]; then
  echo "Usage:"
  echo -e "\t$0 domain private_ip"
  exit 1
fi

domain=$1
private_ip=$2

export CONFIG=`mktemp -t config.XXXXXXXX`
cat <<EOF >$CONFIG
{
  "api": "api.$domain",
  "admin_user": "admin",
  "admin_password": "admin",
  "apps_domain": "$domain",
  "cf_push_timeout": 1200,
  "long_curl_timeout": 1200,
  "secure_address": "${private_ip}:4001",
  "skip_ssl_validation": true
}
EOF

micropcf_dir=$(cd `dirname $0` && cd .. && pwd)
diego_release_dir=$micropcf_dir/images/releases/diego-release

pushd $micropcf_dir/test/src/github.com/cloudfoundry-incubator/diego-acceptance-tests >/dev/null
  export GOPATH=$micropcf_dir/test:$diego_release_dir
  export PATH=$GOPATH/bin:$PATH
  ./bin/test --skip='DEA Compatibility|scp'
popd >/dev/null
